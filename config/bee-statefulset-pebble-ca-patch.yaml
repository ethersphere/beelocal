# StatefulSet patch template for adding Pebble CA certificate to bee nodes
# This patch modifies the main bee container to install the Pebble root CA certificate
# before starting the bee process. The certificate is installed directly into the
# container's filesystem using update-ca-certificates.
#
# Prerequisites:
#   1. Pebble must be deployed and accessible at https://pebble:15000
#   2. The bee container image must support apt-get (Debian/Ubuntu based)
#
# Usage with kubectl patch:
#   kubectl patch statefulset <statefulset-name> -n <namespace> --type='strategic' -p "$(cat config/bee-statefulset-pebble-ca-patch.yaml)"
#
# For beekeeper integration:
#   Apply this patch structure when creating bee node StatefulSets to ensure
#   they can trust Pebble's ACME server certificate.

spec:
  template:
    spec:
      containers:
      - name: bee
        # Temporarily run as root to install certificates, then switch back to original user
        securityContext:
          runAsUser: 0
        # Modify command to install certificate first, then start bee
        command:
        - /bin/bash
        - -c
        - |
          set -ex
          
          # Fetch all required Pebble certs
          # We use -k because we haven't trusted the server yet. We use --fail to exit on HTTP error.
          curl -k -s --fail https://pebble:15000/roots/0 > /usr/local/share/ca-certificates/pebble-root-real.crt
          curl -k -s --fail https://pebble:15000/intermediates/0 > /usr/local/share/ca-certificates/pebble-intermediate-real.crt
          curl -k -s --fail https://raw.githubusercontent.com/letsencrypt/pebble/refs/heads/main/test/certs/pebble.minica.pem > /usr/local/share/ca-certificates/pebble-minica.crt
          
          echo "--- Downloaded certs ---"
          ls -l /usr/local/share/ca-certificates/
          echo "--- End Downloaded certs ---"

          # Update the system trust store
          update-ca-certificates
          
          # --- VERIFICATION ---
          echo "Verifying connection to Pebble ACME server..."
          
          # Attempt to connect to the ACME endpoint securely. 
          # If this fails, the CA was not installed correctly.
          if curl --head --fail https://pebble:14000/dir; then
              echo "Successfully connected to Pebble."
          else
              echo "Failed to connect to Pebble after updating CA certificates."
              exit 1
          fi
          
          # Exec into the original bee command (replaces shell with bee process)
          exec bee start --config=.bee.yaml
